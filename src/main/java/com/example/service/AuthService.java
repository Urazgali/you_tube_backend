package com.example.service;import com.example.dto.ApiResponse;import com.example.dto.AuthDTO;import com.example.dto.ProfileDTO;import com.example.dto.RegistrationDTO;import com.example.entity.ProfileEntity;import com.example.enums.Language;import com.example.enums.ProfileRole;import com.example.enums.ProfileStatus;import com.example.repository.EmailHistoryRepository;import com.example.repository.ProfileRepository;import com.example.util.JWTUtil;import com.example.util.MD5Util;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.context.support.ResourceBundleMessageSource;import org.springframework.stereotype.Service;import java.time.LocalDateTime;import java.util.Locale;import java.util.Optional;@Servicepublic class AuthService {    @Autowired    private ProfileRepository profileRepository;    @Autowired    private EmailHistoryRepository emailHistoryRepository;    @Autowired    private EmailSenderService emailSenderService;    private final Logger log = LoggerFactory.getLogger(AuthService.class);    @Autowired    private ResourceBundleService resourceBundleService;    public ApiResponse login(AuthDTO dto, Language lang) {        Optional<ProfileEntity> byEmail = profileRepository.findByEmail(dto.getEmail());        if (byEmail.isPresent()) {            ProfileEntity entity = byEmail.get();            log.info("login " + dto.getEmail());            return new ApiResponse(true, TO_DTO(entity));        }        return new ApiResponse(false, resourceBundleService.getMessage("item.not.found", lang));    }    public ApiResponse registration(RegistrationDTO dto, Language lang) {        Optional<ProfileEntity> optionalProfile = profileRepository.findByEmail(dto.getEmail());        if (optionalProfile.isPresent()) {            if (optionalProfile.get().getStatus().equals(ProfileStatus.REGISTRATION)) {                profileRepository.delete(optionalProfile.get()); // delete            } else {                return new ApiResponse(false, resourceBundleService.getMessage("email.already.exists", lang));            }        }        Long count = emailHistoryRepository.countAllByToEmailAndCreatedDateAfter(dto.getEmail(), LocalDateTime.now().minusMinutes(1));        if (count > 4) {            return new ApiResponse(false, resourceBundleService.getMessage("try.again.around.1minute", lang));        }        ProfileEntity entity = new ProfileEntity();        entity.setName(dto.getName());        entity.setSurname(dto.getSurname());        entity.setEmail(dto.getEmail());        entity.setPassword(MD5Util.encode(dto.getPassword()));        entity.setRole(ProfileRole.ROLE_USER);        entity.setStatus(ProfileStatus.REGISTRATION);        entity.setLanguage(lang);        //entity.setPrtId(dto.getPhotoId());        profileRepository.save(entity);        log.info("registration  " + dto.getEmail());        return emailSenderService.sendEmailVerification(dto.getEmail());    }    private ProfileDTO TO_DTO(ProfileEntity entity) {        ProfileDTO dto = new ProfileDTO();        dto.setEmail(entity.getEmail());        dto.setId(entity.getId());        dto.setRole(entity.getRole());        dto.setStatus(entity.getStatus());        dto.setName(entity.getName());        dto.setSurname(entity.getSurname());//        dto.setPhotoId(entity.getPhotoId()); // TODO        dto.setJwt(JWTUtil.encode(entity.getEmail()));        return dto;    }}